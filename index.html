<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Street Anthropology</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: white;
            color: black;
            min-height: 100vh;
        }
        
        .header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee;
            z-index: 100;
            padding: 20px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        
        h1 {
            font-family: "Consolas", "Monaco", monospace;
            font-size: 28px;
            margin: 0;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .metadata {
            font-size: 12px;
            color: #666;
            font-family: "Consolas", monospace;
            text-align: right;
            line-height: 1.3;
        }

        .metadata strong {
            font-weight: bold;
            color: #333;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .upload-section {
            margin-bottom: 40px;
        }

        .prompt {
            font-family: "Consolas", "Monaco", monospace;
            font-size: 14px;
            margin-bottom: 20px;
            color: #666;
            letter-spacing: 0.5px;
        }
        
        .upload-zone {
            border: 1px solid #ccc;
            padding: 30px 20px;
            margin: 0 auto;
            max-width: 400px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: "Consolas", "Monaco", monospace;
            background: #fafafa;
        }
        
        .upload-zone:hover {
            background: #f0f0f0;
            border-color: #000;
        }

        .upload-text {
            font-size: 12px;
            line-height: 1.4;
            color: #666;
        }

        .masonry-container {
            column-count: 4;
            column-gap: 15px;
            column-fill: balance;
        }

        @media (max-width: 1000px) {
            .masonry-container {
                column-count: 3;
            }
        }

        @media (max-width: 700px) {
            .masonry-container {
                column-count: 2;
            }
        }

        @media (max-width: 500px) {
            .masonry-container {
                column-count: 1;
            }
        }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 20px;
            position: relative;
            background: white;
            border: 1px solid #ddd;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .masonry-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #333;
        }

        .masonry-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .item-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: "Consolas", monospace;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .masonry-item:hover .item-overlay {
            opacity: 1;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            position: relative;
            background: white;
            border: 2px solid #333;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-image-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            min-height: 300px;
            max-height: calc(90vh - 150px);
            overflow: hidden;
        }

        .modal-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
        }

        .modal-info {
            padding: 20px;
            font-family: "Consolas", monospace;
            font-size: 14px;
            background: #f8f8f8;
            border-top: 1px solid #ddd;
            line-height: 1.6;
        }

        .modal-info div {
            margin-bottom: 8px;
        }

        .modal-info div:last-child {
            margin-bottom: 0;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-family: "Consolas", monospace;
            font-size: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
            z-index: 10;
        }

        .modal-nav:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .modal-nav.prev {
            left: 10px;
        }

        .modal-nav.next {
            right: 10px;
        }

        .modal-counter {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 15px;
            font-family: "Consolas", monospace;
            font-size: 12px;
            border-radius: 20px;
            z-index: 10;
        }

        .item-location {
            font-weight: bold;
        }

        .item-timestamp {
            color: #ccc;
            font-size: 11px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-style: italic;
            font-family: "Consolas", monospace;
            color: #666;
        }
        
        .progress-bar {
            width: 100%;
            max-width: 500px;
            height: 4px;
            background: #eee;
            margin: 20px auto;
            display: none;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #333;
            width: 0%;
            transition: width 0.3s ease;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .modal-nav {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .modal-nav.prev {
                left: 5px;
            }
            
            .modal-nav.next {
                right: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Street Anthropology</h1>
            <div class="metadata" id="metadata">
                Archive uptime: --d --h --m --s<br>
                Entries logged: --<br>
                Last update: --m ago, --
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="upload-section">
            <div class="prompt">Archive the ephemeral details of urban life</div>
            
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-text">
                    DOCUMENT FINDINGS<br>
                    Drop images here or click to browse<br>
                    <span style="font-size: 12px; color: #999;">Phone photos while walking preferred</span>
                </div>
                <input type="file" id="fileInput" accept="image/*" multiple>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="loading" id="uploadLoading" style="display: none;">Processing documentation...</div>
        </div>

        <div class="masonry-container" id="masonryGallery">
            <div class="loading">Initializing archive...</div>
        </div>
    </div>

    <!-- Modal for image viewing -->
    <div class="modal" id="modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="window.closeModal()">×</button>
            <button class="modal-nav prev" onclick="window.navigateModal(-1)">‹</button>
            <button class="modal-nav next" onclick="window.navigateModal(1)">›</button>
            <div class="modal-counter" id="modalCounter">1 / 1</div>
            <div class="modal-image-container">
                <img id="modalImage" class="modal-image" src="" alt="Street documentation">
            </div>
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <!-- EXIF library for GPS extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>
    
    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://aifbugdoafvywupdvqbl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZmJ1Z2RvYWZ2eXd1cGR2cWJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MTM4ODAsImV4cCI6MjA3MTk4OTg4MH0.U4iGfgbQ6tLpWJUVRMls14cJjI3iJjbVE7smiCFAMck';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        // Track when the archive started - August 28th, 2025 at 9:00 PM
        const archiveStartTime = new Date(2025, 7, 28, 21, 0, 0);
        
        let currentData = [];
        let currentModalIndex = 0;
        
        // Update metadata in real-time with seconds
        function updateMetadata(totalCount = null, lastUpload = null) {
            const now = new Date();
            const timeDiff = Math.max(0, now - archiveStartTime);
            
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            
            let metadataHTML = `<strong>Archive uptime:</strong> ${days}d ${hours}h ${minutes}m ${seconds}s<br>`;
            
            if (totalCount !== null) {
                metadataHTML += `<strong>Entries logged:</strong> ${totalCount}<br>`;
            } else {
                metadataHTML += `<strong>Entries logged:</strong> --<br>`;
            }
            
            if (lastUpload) {
                const uploadTime = new Date(lastUpload.created_at);
                const timeSinceUpload = Math.floor((now - uploadTime) / (1000 * 60));
                const location = lastUpload.location.split(',')[0].trim();
                
                if (timeSinceUpload < 60) {
                    metadataHTML += `<strong>Last update:</strong> ${timeSinceUpload}m ago, ${location}`;
                } else {
                    const hours = Math.floor(timeSinceUpload / 60);
                    const minutes = timeSinceUpload % 60;
                    metadataHTML += `<strong>Last update:</strong> ${hours}h ${minutes}m ago, ${location}`;
                }
            } else {
                metadataHTML += `<strong>Last update:</strong> --m ago, --`;
            }
            
            document.getElementById('metadata').innerHTML = metadataHTML;
        }
        
        // Update metadata every second for live feel
        setInterval(() => {
            const lastUpload = currentData.length > 0 ? currentData[0] : null;
            updateMetadata(currentData.length, lastUpload);
        }, 1000);
        
        // Extract GPS coordinates from image EXIF data
        function getGPSFromExif(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const lat = EXIF.getTag(this, "GPSLatitude");
                    const lon = EXIF.getTag(this, "GPSLongitude");
                    const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                    const lonRef = EXIF.getTag(this, "GPSLongitudeRef");
                    
                    if (lat && lon && latRef && lonRef) {
                        const latDec = lat[0] + lat[1]/60 + lat[2]/3600;
                        const lonDec = lon[0] + lon[1]/60 + lon[2]/3600;
                        
                        const finalLat = latRef === 'N' ? latDec : -latDec;
                        const finalLon = lonRef === 'E' ? lonDec : -lonDec;
                        
                        resolve({ lat: finalLat, lon: finalLon });
                    } else {
                        resolve(null);
                    }
                });
            });
        }
        
        // Get location from GPS coordinates
        async function getLocationFromGPS(lat, lon) {
            try {
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const data = await response.json();
                return `${data.locality}, ${data.principalSubdivision}`;
            } catch (error) {
                return 'Location not specified';
            }
        }

        // Calculate time display
        function getTimeDisplay(created_at) {
            const uploadDate = new Date(created_at);
            const timeAgo = Math.floor((new Date() - uploadDate) / (1000 * 60));
            
            if (timeAgo < 60) {
                return `${timeAgo}m ago`;
            } else if (timeAgo < 1440) {
                const hours = Math.floor(timeAgo / 60);
                const minutes = timeAgo % 60;
                return `${hours}h ${minutes}m ago`;
            } else {
                const days = Math.floor(timeAgo / 1440);
                return `${days}d ago`;
            }
        }

        // Create masonry item element
        function createMasonryItem(sticker, index) {
            const item = document.createElement('div');
            item.className = 'masonry-item';
            item.dataset.index = index;
            
            const timeDisplay = getTimeDisplay(sticker.created_at);
            
            // Add click handler for modal view
            item.addEventListener('click', () => {
                showModal(index);
            });
            
            item.innerHTML = `
                <img src="${sticker.image_url}" alt="Street documentation" loading="lazy">
                <div class="item-overlay">
                    <div class="item-location">${sticker.location}</div>
                    <div class="item-timestamp">${timeDisplay}</div>
                </div>
            `;
            
            return item;
        }

        // Update modal content
        function updateModalContent() {
            if (currentData.length === 0) return;
            
            const sticker = currentData[currentModalIndex];
            const modalImage = document.getElementById('modalImage');
            const modalInfo = document.getElementById('modalInfo');
            const modalCounter = document.getElementById('modalCounter');
            
            const timeDisplay = getTimeDisplay(sticker.created_at);
            const uploadDate = new Date(sticker.created_at);
            const fullDate = uploadDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Update image with loading state
            modalImage.style.opacity = '0.5';
            modalImage.onload = () => {
                modalImage.style.opacity = '1';
            };
            modalImage.src = sticker.image_url;
            
            // Update info
            modalInfo.innerHTML = `
                <div><strong>Location:</strong> ${sticker.location}</div>
                <div><strong>Documented:</strong> ${timeDisplay}</div>
                <div><strong>Full Date:</strong> ${fullDate}</div>
                ${sticker.gps_lat && sticker.gps_lon ? 
                    `<div><strong>GPS:</strong> ${sticker.gps_lat.toFixed(6)}, ${sticker.gps_lon.toFixed(6)}</div>` : ''}
                <div><strong>Archive ID:</strong> #${currentData.length - currentModalIndex}</div>
            `;
            
            // Update counter
            modalCounter.textContent = `${currentModalIndex + 1} / ${currentData.length}`;
        }

        // Show modal with image and metadata
        window.showModal = function(index) {
            currentModalIndex = index;
            const modal = document.getElementById('modal');
            
            updateModalContent();
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Add keyboard navigation
            document.addEventListener('keydown', handleModalKeyboard);
        }

        // Close modal
        window.closeModal = function() {
            const modal = document.getElementById('modal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Remove keyboard navigation
            document.removeEventListener('keydown', handleModalKeyboard);
        }

        // Navigate modal
        window.navigateModal = function(direction) {
            if (currentData.length === 0) return;
            
            currentModalIndex = currentModalIndex + direction;
            
            // Wrap around
            if (currentModalIndex < 0) {
                currentModalIndex = currentData.length - 1;
            } else if (currentModalIndex >= currentData.length) {
                currentModalIndex = 0;
            }
            
            updateModalContent();
        }

        // Handle keyboard navigation in modal
        function handleModalKeyboard(e) {
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    window.navigateModal(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    window.navigateModal(1);
                    break;
                case 'Escape':
                    e.preventDefault();
                    window.closeModal();
                    break;
            }
        }

        // Close modal on background click
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeModal();
            }
        });

        // Render masonry gallery
        function renderGallery() {
            const gallery = document.getElementById('masonryGallery');
            
            if (currentData.length === 0) {
                gallery.innerHTML = '<div class="loading">No documentation yet. Start the archive.</div>';
                return;
            }
            
            gallery.innerHTML = '';
            currentData.forEach((sticker, index) => {
                gallery.appendChild(createMasonryItem(sticker, index));
            });
        }
        
        // Auto-upload on file selection
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('uploadLoading').style.display = 'block';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                const progress = ((i + 0.5) / files.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                
                try {
                    let location = 'Location not specified';
                    let gpsData = null;
                    const gpsCoords = await getGPSFromExif(file);
                    
                    if (gpsCoords) {
                        gpsData = gpsCoords;
                        const addressData = await getLocationFromGPS(gpsCoords.lat, gpsCoords.lon);
                        if (addressData) {
                            location = addressData;
                        }
                    }
                    
                    const fileName = `${Date.now()}_${file.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('stickers')
                        .upload(fileName, file);
                    
                    if (uploadError) throw uploadError;
                    
                    const { data: urlData } = supabase.storage
                        .from('stickers')
                        .getPublicUrl(fileName);
                    
                    const insertObject = {
                        image_url: urlData.publicUrl,
                        location: location,
                        created_at: new Date().toISOString(),
                        date: new Date().toLocaleDateString()
                    };
                    
                    if (gpsData) {
                        insertObject.gps_lat = gpsData.lat;
                        insertObject.gps_lon = gpsData.lon;
                    }
                    
                    const { data: insertData, error: dbError } = await supabase
                        .from('sticker_posts')
                        .insert(insertObject)
                        .select()
                        .single();
                    
                    if (dbError) throw dbError;
                    
                    // Add new item to beginning of array and re-render
                    currentData.unshift(insertData);
                    renderGallery();
                    
                    const finalProgress = ((i + 1) / files.length) * 100;
                    document.getElementById('progressFill').style.width = finalProgress + '%';
                    
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert(`Documentation failed for ${file.name}: ${error.message}`);
                }
            }
            
            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
                document.getElementById('uploadLoading').style.display = 'none';
                document.getElementById('progressFill').style.width = '0%';
            }, 500);
            
            document.getElementById('fileInput').value = '';
        });
        
        // Load all stickers
        async function loadStickers() {
            try {
                const { data: stickers, error } = await supabase
                    .from('sticker_posts')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                currentData = stickers;
                renderGallery();
                
            } catch (error) {
                console.error('Error loading documentation:', error);
                document.getElementById('masonryGallery').innerHTML = '<div class="loading">Error loading archive.</div>';
            }
        }
        
        // Drag and drop functionality
        const uploadZone = document.querySelector('.upload-zone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.background = '#e8e8e8';
            uploadZone.style.borderColor = '#000';
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.style.background = '#fafafa';
            uploadZone.style.borderColor = '#333';
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.style.background = '#fafafa';
            uploadZone.style.borderColor = '#333';
            
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length === 0) return;
            
            // Trigger upload via file input
            const fileInput = document.getElementById('fileInput');
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;
            fileInput.dispatchEvent(new Event('change'));
        });
        
        // Initialize
        loadStickers();
        updateMetadata();
    </script>
</body>
</html>
